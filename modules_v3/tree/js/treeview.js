function TreeViewHandler(d,f){this.treeview=jQuery("#"+d+"_in");this.loadingImage=jQuery("#"+d+"_loading");this.toolbox=jQuery("#tv_tools");this.buttons=jQuery(".tv_button:first",this.toolbox);this.zoom=100;this.boxWidth=180;this.boxExpandedWidth=250;this.cookieDays=360;this.ajaxUrl="module.php?mod=tree&instance="+d+"&allPartners="+(f?"true":"false")+"&mod_action=";this.container=this.treeview.parent();this.updating=this.auto_box_width=!1;this.overLevel=0;var e=this;"true"==readCookie("compact")&&e.compact();readCookie("allPartners")!=f&&createCookie("allPartners",f,this.cookieDays);e.treeview.draggable({cursor:"move",stop:function(){e.updateTree()}});e.toolbox.find("#tvbCompact").each(function(a,g){g.onclick=function(){e.compact()}});e.toolbox.find("#tvbOpen").each(function(a,h){var g=jQuery(h,e.toolbox);h.onclick=function(){g.addClass("tvPressed");e.setLoading();var c=jQuery.Event("click");e.treeview.find(".tv_box:not(.boxExpanded)").each(function(j,i){var b=jQuery(i,e.treeview).offset();b.left>=e.leftMin&&(b.left<=e.leftMax&&b.top>=e.topMin&&b.top<=e.topMax)&&e.expandBox(i,c)});g.removeClass("tvPressed");e.setComplete()}});e.toolbox.find("#tvbClose").each(function(a,h){var g=jQuery(h,e.toolbox);h.onclick=function(){g.addClass("tvPressed");e.setLoading();e.treeview.find(".tv_box.boxExpanded").each(function(i,c){jQuery(c).css("display","none").removeClass("boxExpanded").parent().find(".tv_box.collapsedContent").css("display","block")});g.removeClass("tvPressed");e.setComplete()}});e.centerOnRoot();return !1}TreeViewHandler.prototype.setLoading=function(){this.treeview.css("cursor","wait");this.loadingImage.css("display","block")};TreeViewHandler.prototype.setComplete=function(){this.treeview.css("cursor","move");this.loadingImage.css("display","none")};TreeViewHandler.prototype.getSize=function(){var a=this.container.parent(),d=a.offset();this.leftMin=d.left;this.leftMax=this.leftMin+a.innerWidth();this.topMin=d.top;this.topMax=this.topMin+a.innerHeight()};TreeViewHandler.prototype.updateTree=function(f,j){var g=this,i=[],h=[];this.getSize();g.treeview.find("td[abbr]").each(function(a,e){e=jQuery(e,g.treeview);var d=e.offset();d.left>=g.leftMin&&(d.left<=g.leftMax&&d.top>=g.topMin&&d.top<=g.topMax)&&(i.push(e.attr("abbr")),h.push(e))});0<i.length?(g.updating=!0,g.setLoading(),jQuery.ajax({url:g.ajaxUrl+"getPersons",dataType:"json",data:"q="+i.join(";"),success:function(a){for(var n=h.length,m=jQuery(".rootPerson",this.treeview),e=m.offset().left,l=0;l<n;l++){h[l].removeAttr("abbr").html(a[l])}g.treeview.offset({left:g.treeview.offset().left-m.offset().left+e});g.getSize()},complete:function(){g.treeview.find("td[abbr]").length&&g.updateTree(f,j);g.auto_box_width&&g.treeview.find(".tv_box").css("width","auto");g.updating=!0;!0==f&&g.centerOnRoot();j&&j.removeClass("tvPressed");g.setComplete();g.updating=!1},timeout:function(){j&&j.removeClass("tvPressed");g.updating=!1;g.setComplete()}})):(j&&j.removeClass("tvPressed"),g.setComplete());return !1};TreeViewHandler.prototype.compact=function(){var d=jQuery("#tvbCompact",this.toolbox);this.setLoading();if(this.auto_box_width){var f=this.boxWidth*(this.zoom/100)+"px",e=this.boxExpandedWidth*(this.zoom/100)+"px";this.treeview.find(".tv_box:not(boxExpanded)",this.treeview).css("width",f);this.treeview.find(".boxExpanded",this.treeview).css("width",e);this.auto_box_width=!1;readCookie("compact")&&createCookie("compact",!1,this.cookieDays);d.removeClass("tvPressed")}else{this.treeview.find(".tv_box").css("width","auto"),this.auto_box_width=!0,readCookie("compact")||createCookie("compact",!0,this.cookieDays),this.updating||this.updateTree(),d.addClass("tvPressed")}this.setComplete();return !1};TreeViewHandler.prototype.centerOnRoot=function(){this.loadingImage.css("display","block");var e=this.container,h=e.innerWidth()/2;if(isNaN(h)){return !1}var f=e.innerHeight()/2,g=jQuery(".rootPerson",this.treeview),h=e.offset().left+this.treeview.offset().left+h-g.offset().left-g.outerWidth()/2,e=e.offset().top+this.treeview.offset().top+f-g.offset().top-g.outerHeight()/2;this.treeview.offset({left:h,top:e});this.updating||this.updateTree(!0);return !1};TreeViewHandler.prototype.expandBox=function(i,p){if(jQuery(p.target).hasClass("tv_link")){return !1}i=jQuery(i,this.treeview);var j=i.parent(),o=i.attr("abbr"),n=this,m,k;if(j.hasClass("detailsLoaded")){k=j.find(".collapsedContent"),m=j.find(".tv_box:not(.collapsedContent)")}else{m=i;k=i.clone();j.append(k.addClass("collapsedContent").css("display","none"));var l=this.loadingImage.find("img").clone().addClass("tv_box_loading").css("display","block");i.prepend(l);n.updating=!0;n.setLoading();i.load(n.ajaxUrl+"getDetails&pid="+o,function(){"function"==typeof CB_Init&&CB_Init();i.css("width",n.boxExpandedWidth*(n.zoom/100)+"px");l.remove();j.addClass("detailsLoaded");n.setComplete();n.updating=!1})}i.hasClass("boxExpanded")?(m.css("display","none"),k.css("display","block"),i.removeClass("boxExpanded")):(m.css("display","block"),k.css("display","none"),m.addClass("boxExpanded"));this.getSize();return !1};function createCookie(e,h,f){if(f){var g=new Date;g.setTime(g.getTime()+86400000*f);f="; expires="+g.toGMTString()}else{f=""}document.cookie=e+"="+h+f+"; path=/"}function readCookie(e){e+="=";for(var h=document.cookie.split(";"),f=0;f<h.length;f++){for(var g=h[f];" "==g.charAt(0);){g=g.substring(1,g.length)}if(0==g.indexOf(e)){return g.substring(e.length,g.length)}}return null}function eraseCookie(a){createCookie(a,"",-1)};